{"version":3,"sources":["../../src/recurrent/rnn-time-step.js"],"names":["RNNTimeStep","model","input","RandomMatrix","inputSize","outputSize","lastHiddenSize","hiddenLayers","length","outputConnector","output","Matrix","layers","equation","Equation","outputs","equationConnection","equationConnections","initialLayerInputs","getEquation","push","i","max","add","multiply","equations","runs","errorSum","bindEquation","inputIndex","current","next","runInput","weights","error","Math","abs","deltas","totalCost","runBackpropagate","isRunnable","lastOutput","outputMatrix","states","jsonString","JSON","stringify","toJSON","matrixOrigin","m","stateIndex","state","j","previousConnectionIndex","left","rows","columns","right","product","Error","connection","indexOf","matrixToString","hiddenLayer","p","hasOwnProperty","toInner","fnString","toString","split","shift","join","pop","replace","fileName","fnName","value","toLowerCase","statesRaw","usedFunctionNames","innerFunctionsSwitch","forwardFn","name","src","dataFormatter","toFunctionString","formatDataIn","formatDataOut","zeros","softmax","randomF","sampleI","maxI","Function","RNN","defaults","learningRate","decayRate","smoothEps","regc","clipval","trainDefaults"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;;;;;;;;;IAEqBA,W;;;;;;;;;;;wCACC;AAClB,WAAKC,KAAL,CAAWC,KAAX,GAAmB,IAAIC,sBAAJ,CAAiB,KAAKC,SAAtB,EAAiC,CAAjC,EAAoC,IAApC,CAAnB;AACD;;;yCAEoB;AACnB,UAAIH,QAAQ,KAAKA,KAAjB;AACA,UAAII,aAAa,KAAKA,UAAtB;AACA,UAAIC,iBAAiB,KAAKC,YAAL,CAAkB,KAAKA,YAAL,CAAkBC,MAAlB,GAA2B,CAA7C,CAArB;;AAEA;AACAP,YAAMQ,eAAN,GAAwB,IAAIN,sBAAJ,CAAiBE,UAAjB,EAA6BC,cAA7B,EAA6C,IAA7C,CAAxB;AACA;AACAL,YAAMS,MAAN,GAAe,IAAIC,gBAAJ,CAAWN,UAAX,EAAuB,CAAvB,CAAf;AACD;;;mCAEc;AACb,UAAIJ,QAAQ,KAAKA,KAAjB;AACA,UAAIM,eAAe,KAAKA,YAAxB;AACA,UAAIK,SAASX,MAAMM,YAAnB;AACA,UAAIM,WAAW,IAAIC,kBAAJ,EAAf;AACA,UAAIC,UAAU,EAAd;AACA,UAAIC,qBAAqBf,MAAMgB,mBAAN,CAA0BT,MAA1B,GAAmC,CAAnC,GACrBP,MAAMgB,mBAAN,CAA0BhB,MAAMgB,mBAAN,CAA0BT,MAA1B,GAAmC,CAA7D,CADqB,GAErB,KAAKU,kBAFT;;AAKE;AACF,UAAIR,SAAS,KAAKS,WAAL,CAAiBN,QAAjB,EAA2BA,SAASX,KAAT,CAAeD,MAAMC,KAArB,CAA3B,EAAwDc,mBAAmB,CAAnB,CAAxD,EAA+EJ,OAAO,CAAP,CAA/E,CAAb;AACAG,cAAQK,IAAR,CAAaV,MAAb;AACA;AACA,WAAK,IAAIW,IAAI,CAAR,EAAWC,MAAMf,aAAaC,MAAnC,EAA2Ca,IAAIC,GAA/C,EAAoDD,GAApD,EAAyD;AACvDX,iBAAS,KAAKS,WAAL,CAAiBN,QAAjB,EAA2BH,MAA3B,EAAmCM,mBAAmBK,CAAnB,CAAnC,EAA0DT,OAAOS,CAAP,CAA1D,CAAT;AACAN,gBAAQK,IAAR,CAAaV,MAAb;AACD;;AAEDT,YAAMgB,mBAAN,CAA0BG,IAA1B,CAA+BL,OAA/B;AACAF,eAASU,GAAT,CAAaV,SAASW,QAAT,CAAkBvB,MAAMQ,eAAxB,EAAyCC,MAAzC,CAAb,EAA+DT,MAAMS,MAArE;AACAT,YAAMwB,SAAN,CAAgBL,IAAhB,CAAqBP,QAArB;AACD;;AAED;;;;;;;;6BAKSX,K,EAAO;AACd,WAAKwB,IAAL;AACA,UAAIzB,QAAQ,KAAKA,KAAjB;AACA,UAAI0B,WAAW,CAAf;AACA,UAAId,iBAAJ;AACA,aAAOZ,MAAMwB,SAAN,CAAgBjB,MAAhB,GAAyBN,MAAMM,MAAN,GAAe,CAA/C,EAAkD;AAChD,aAAKoB,YAAL;AACD;AACD,UAAMb,UAAU,EAAhB;;AAEA,UAAI,KAAKX,SAAL,KAAmB,CAAvB,EAA0B;AACxB,aAAK,IAAIyB,aAAa,CAAjB,EAAoBP,MAAMpB,MAAMM,MAAN,GAAe,CAA9C,EAAiDqB,aAAaP,GAA9D,EAAmEO,YAAnE,EAAiF;AAC/E;AACAhB,qBAAWZ,MAAMwB,SAAN,CAAgBI,UAAhB,CAAX;;AAEA,cAAMC,UAAU5B,MAAM2B,UAAN,CAAhB;AACA,cAAME,OAAO7B,MAAM2B,aAAa,CAAnB,CAAb;AACA,cAAMnB,SAASG,SAASmB,QAAT,CAAkB,CAACF,OAAD,CAAlB,CAAf;AACA,eAAK,IAAIT,IAAI,CAAb,EAAgBA,IAAIX,OAAOuB,OAAP,CAAezB,MAAnC,EAA2Ca,GAA3C,EAAgD;AAC9C,gBAAMa,QAAQxB,OAAOuB,OAAP,CAAeZ,CAAf,IAAoBU,IAAlC;AACA;AACAJ,wBAAYQ,KAAKC,GAAL,CAASF,KAAT,CAAZ;;AAEA;AACAxB,mBAAO2B,MAAP,CAAchB,CAAd,IAAmBa,KAAnB;AACAnB,oBAAQK,IAAR,CAAaV,OAAOuB,OAApB;AACD;AACF;AACF,OAlBD,MAkBO;AACL,aAAK,IAAIJ,cAAa,CAAjB,EAAoBP,OAAMpB,MAAMM,MAAN,GAAe,CAA9C,EAAiDqB,cAAaP,IAA9D,EAAmEO,aAAnE,EAAiF;AAC/E;AACAhB,qBAAWZ,MAAMwB,SAAN,CAAgBI,WAAhB,CAAX;;AAEA,cAAMC,WAAU5B,MAAM2B,WAAN,CAAhB;AACA,cAAME,QAAO7B,MAAM2B,cAAa,CAAnB,CAAb;AACA,cAAMnB,UAASG,SAASmB,QAAT,CAAkBF,QAAlB,CAAf;AACA,eAAK,IAAIT,KAAI,CAAb,EAAgBA,KAAIX,QAAOuB,OAAP,CAAezB,MAAnC,EAA2Ca,IAA3C,EAAgD;AAC9C,gBAAMa,SAAQxB,QAAOuB,OAAP,CAAeZ,EAAf,IAAoBU,MAAKV,EAAL,CAAlC;AACA;AACAM,wBAAYQ,KAAKC,GAAL,CAASF,MAAT,CAAZ;;AAEA;AACAxB,oBAAO2B,MAAP,CAAchB,EAAd,IAAmBa,MAAnB;AACAnB,oBAAQK,IAAR,CAAaV,QAAOuB,OAApB;AACD;AACF;AACF;AACD;AACA,WAAKK,SAAL,GAAiBX,QAAjB;AACA,aAAOA,QAAP;AACD;;;uCAEkB;AACjB,WAAK,IAAIN,IAAI,KAAKpB,KAAL,CAAWwB,SAAX,CAAqBjB,MAArB,GAA8B,CAA3C,EAA8Ca,IAAI,CAAC,CAAnD,EAAsDA,GAAtD,EAA2D;AACzD,aAAKpB,KAAL,CAAWwB,SAAX,CAAqBJ,CAArB,EAAwBkB,gBAAxB;AACD;AACF;;AAGD;;;;;;;;0BAKgB;AAAA,UAAZrC,KAAY,uEAAJ,EAAI;;AACd,UAAI,CAAC,KAAKsC,UAAV,EAAsB,OAAO,IAAP;AACtB,UAAMvC,QAAQ,KAAKA,KAAnB;AACA,aAAOA,MAAMwB,SAAN,CAAgBjB,MAAhB,GAAyBN,MAAMM,MAAtC,EAA8C;AAC5C,aAAKoB,YAAL;AACD;AACD,UAAIa,mBAAJ;AACA,UAAI,KAAKrC,SAAL,KAAmB,CAAvB,EAA0B;AACxB,aAAK,IAAIiB,IAAI,CAAb,EAAgBA,IAAInB,MAAMM,MAA1B,EAAkCa,GAAlC,EAAuC;AACrC,cAAIqB,eAAezC,MAAMwB,SAAN,CAAgBJ,CAAhB,EAAmBW,QAAnB,CAA4B,CAAC9B,MAAMmB,CAAN,CAAD,CAA5B,CAAnB;AACAoB,uBAAaC,aAAaT,OAA1B;AACD;AACF,OALD,MAKO;AACL,aAAK,IAAIZ,MAAI,CAAb,EAAgBA,MAAInB,MAAMM,MAA1B,EAAkCa,KAAlC,EAAuC;AACrC,cAAIqB,gBAAezC,MAAMwB,SAAN,CAAgBJ,GAAhB,EAAmBW,QAAnB,CAA4B9B,MAAMmB,GAAN,CAA5B,CAAnB;AACAoB,uBAAaC,cAAaT,OAA1B;AACD;AACF;AACD,UAAI,KAAK5B,UAAL,KAAoB,CAAxB,EAA2B;AACzB,eAAOoC,WAAW,CAAX,CAAP;AACD;AACD,aAAOA,UAAP;AACD;;AAED;;;;;;;iCAIa;AACX,UAAIxC,QAAQ,KAAKA,KAAjB;AACA,UAAIwB,YAAY,KAAKxB,KAAL,CAAWwB,SAA3B;AACA,UAAMrB,YAAY,KAAKA,SAAvB;AACA;AACA,UAAIS,WAAWY,UAAU,CAAV,CAAf;AACA,UAAIkB,SAAS9B,SAAS8B,MAAtB;AACA,UAAIC,aAAaC,KAAKC,SAAL,CAAe,KAAKC,MAAL,EAAf,CAAjB;;AAEA,eAASC,YAAT,CAAsBC,CAAtB,EAAyBC,UAAzB,EAAqC;AACnC,aAAK,IAAI7B,IAAI,CAAR,EAAWC,MAAMqB,OAAOnC,MAA7B,EAAqCa,IAAIC,GAAzC,EAA8CD,GAA9C,EAAmD;AACjD,cAAI8B,QAAQR,OAAOtB,CAAP,CAAZ;;AAEA,cAAIA,MAAM6B,UAAV,EAAsB;AACpB,gBAAIE,IAAIC,wBAAwBJ,CAAxB,CAAR;AACA,oBAAQA,CAAR;AACE,mBAAKE,MAAMG,IAAX;AACE,oBAAIF,IAAI,CAAC,CAAT,EAAY;AACV,gDAA6BA,CAA7B,sCAA+DA,CAA/D,+BAA4FH,EAAEM,IAA9F,UAAyGN,EAAEO,OAA3G;AACD;AACH,mBAAKL,MAAMM,KAAX;AACE,oBAAIL,IAAI,CAAC,CAAT,EAAY;AACV,gDAA6BA,CAA7B,sCAA+DA,CAA/D,+BAA4FH,EAAEM,IAA9F,UAAyGN,EAAEO,OAA3G;AACD;AACH,mBAAKL,MAAMO,OAAX;AACE,uCAAsBT,EAAEM,IAAxB,UAAmCN,EAAEO,OAArC;AACF;AACE,sBAAMG,MAAM,eAAN,CAAN;AAZJ;AAcD;;AAED,cAAIV,MAAME,MAAMO,OAAhB,EAAyB,mBAAkBrC,CAAlB;AACzB,cAAI4B,MAAME,MAAMM,KAAhB,EAAuB,mBAAkBpC,CAAlB;AACvB,cAAI4B,MAAME,MAAMG,IAAhB,EAAsB,mBAAkBjC,CAAlB;AACvB;AACF;;AAED,eAASgC,uBAAT,CAAiCJ,CAAjC,EAAoC;AAClC,YAAMW,aAAa3D,MAAMgB,mBAAN,CAA0B,CAA1B,CAAnB;AACA,YAAM0B,SAASlB,UAAU,CAAV,EAAakB,MAA5B;AACA,aAAK,IAAItB,IAAI,CAAR,EAAWC,MAAMqB,OAAOnC,MAA7B,EAAqCa,IAAIC,GAAzC,EAA8CD,GAA9C,EAAmD;AACjD,cAAIsB,OAAOtB,CAAP,EAAUqC,OAAV,KAAsBT,CAA1B,EAA6B;AAC3B,mBAAO5B,CAAP;AACD;AACF;AACD,eAAOuC,WAAWC,OAAX,CAAmBZ,CAAnB,CAAP;AACD;;AAED,eAASa,cAAT,CAAwBb,CAAxB,EAA2BC,UAA3B,EAAuC;AACrC,YAAI,CAACD,CAAD,IAAM,CAACA,EAAEM,IAAT,IAAiB,CAACN,EAAEO,OAAxB,EAAiC,OAAO,MAAP;;AAEjC,YAAIP,MAAMhD,MAAMC,KAAhB,EAAuB;AACvB,YAAI+C,MAAMhD,MAAMQ,eAAhB,EAAiC;AACjC,YAAIwC,MAAMhD,MAAMS,MAAhB,EAAwB;;AAExB,aAAK,IAAIW,IAAI,CAAR,EAAWC,MAAMrB,MAAMM,YAAN,CAAmBC,MAAzC,EAAiDa,IAAIC,GAArD,EAA0DD,GAA1D,EAA+D;AAC7D,cAAI0C,cAAc9D,MAAMM,YAAN,CAAmBc,CAAnB,CAAlB;AACA,eAAK,IAAI2C,CAAT,IAAcD,WAAd,EAA2B;AACzB,gBAAI,CAACA,YAAYE,cAAZ,CAA2BD,CAA3B,CAAL,EAAoC;AACpC,gBAAID,YAAYC,CAAZ,MAAmBf,CAAvB,EAA0B;AAC1B,0CAA6B5B,CAA7B,UAAqC2C,CAArC;AACD;AACF;;AAED,eAAOhB,aAAaC,CAAb,EAAgBC,UAAhB,CAAP;AACD;;AAED,eAASgB,OAAT,CAAiBC,QAAjB,EAA2B;AACzB;AACA;AACAA,mBAAWA,SAASC,QAAT,GAAoBC,KAApB,CAA0B,GAA1B,CAAX;AACAF,iBAASG,KAAT;AACA;AACAH,mBAAWA,SAASI,IAAT,CAAc,GAAd,CAAX;AACAJ,mBAAWA,SAASE,KAAT,CAAe,GAAf,CAAX;AACAF,iBAASK,GAAT;AACA;;AAEA,eAAOL,SAASI,IAAT,CAAc,GAAd,EAAmBF,KAAnB,CAAyB,IAAzB,EAA+BE,IAA/B,CAAoC,YAApC,EACJE,OADI,CACI,qCADJ,EAC2CrE,cAAc,CAAd,GAAkB,gCAAlB,GAAqD,8BADhG,EAEJqE,OAFI,CAEI,wBAFJ,EAE8B,EAF9B,EAGJA,OAHI,CAGI,6BAHJ,EAGmC,EAHnC,EAIJA,OAJI,CAII,6BAJJ,EAImC,EAJnC,EAKJA,OALI,CAKI,+BALJ,EAKqC,EALrC,EAMJA,OANI,CAMI,wCANJ,EAM8C,EAN9C,CAAP;AAOD;;AAED,eAASC,QAAT,CAAkBC,MAAlB,EAA0B;AACxB,yCAAgCA,OAAOF,OAAP,CAAe,QAAf,EAAyB,UAASG,KAAT,EAAgB;AAAE,iBAAO,MAAMA,MAAMC,WAAN,EAAb;AAAmC,SAA9E,CAAhC;AACD;;AAED,UAAIC,YAAY,EAAhB;AACA,UAAIC,oBAAoB,EAAxB;AACA,UAAIC,uBAAuB,EAA3B;AACA,WAAK,IAAI3D,IAAI,CAAR,EAAWC,MAAMqB,OAAOnC,MAA7B,EAAqCa,IAAIC,GAAzC,EAA8CD,GAA9C,EAAmD;AACjD,YAAI8B,QAAQR,OAAOtB,CAAP,CAAZ;AACAyD,kBAAU1D,IAAV,aAA0BC,CAA1B,6BACU8B,MAAM8B,SAAN,CAAgBC,IAD1B,yBAESpB,eAAeX,MAAMG,IAArB,EAA2BjC,CAA3B,CAFT,wBAGUyC,eAAeX,MAAMM,KAArB,EAA4BpC,CAA5B,CAHV,0BAIYyC,eAAeX,MAAMO,OAArB,EAA8BrC,CAA9B,CAJZ;;AAOA,YAAIsD,SAASxB,MAAM8B,SAAN,CAAgBC,IAA7B;AACA,YAAI,CAACH,kBAAkBJ,MAAlB,CAAL,EAAgC;AAC9BI,4BAAkBJ,MAAlB,IAA4B,IAA5B;AACAK,+BAAqB5D,IAArB,qBACoBuD,MADpB,YACiCA,WAAW,WAAX,yBAA8CD,SAASC,MAAT,CAA9C,GAAoE,EADrG,qBAEKT,QAAQf,MAAM8B,SAAN,CAAgBb,QAAhB,EAAR,CAFL;AAKD;AACF;;AAED,UAAMe,yEAEJ,KAAKC,aAAL,KAAuB,IAAxB,GAAgC,KAAKA,aAAL,CAAmBC,gBAAnB,EAAhC,GAAwE,EAFnE,8BAKH,KAAKD,aAAL,KAAuB,IAAvB,IAA+B,OAAO,KAAKE,YAAZ,KAA6B,UAA7D,GACI,wBADJ,GAEI,UAPA,yBASM1C,UATN,mLAiBHkC,UAAUP,IAAV,CAAe,SAAf,CAjBG,mDAkBiCO,UAAUtE,MAlB3C,4NAyBPwE,qBAAqBT,IAArB,CAA0B,IAA1B,CAzBO,kCA8BL,KAAKa,aAAL,KAAuB,IAAvB,IAA+B,OAAO,KAAKG,aAAZ,KAA8B,UAA9D,qCACoC,KAAKlF,UAAL,KAAoB,CAApB,GAAwB,0BAAxB,GAAqD,uBADzF,uBAEe,KAAKA,UAAL,KAAoB,CAApB,GAAwB,0BAAxB,GAAqD,uBAFpE,CA9BM,uJAuCL,KAAK+E,aAAL,KAAuB,IAAvB,IAA+B,OAAO,KAAKE,YAAZ,KAA6B,UAA5D,+CAEKpB,QAAQ,KAAKoB,YAAL,CAAkBlB,QAAlB,EAAR,EACGK,OADH,CACW,iCADX,EAC8C,EAD9C,EAEGA,OAFH,CAEW,0BAFX,EAEuC,EAFvC,EAGGA,OAHH,CAGW,uBAHX,EAGoC,MAHpC,CAFL,UAOK,EA9CA,cA+CL,KAAKW,aAAL,KAAuB,IAAvB,IAA+B,OAAO,KAAKG,aAAZ,KAA8B,UAA7D,gDAEKrB,QAAQ,KAAKqB,aAAL,CAAmBnB,QAAnB,EAAR,EACGK,OADH,CACW,iCADX,EAC8C,EAD9C,EAEGA,OAFH,CAEW,0BAFX,EAEuC,EAFvC,EAGGA,OAHH,CAGW,uBAHX,EAGoC,MAHpC,CAFL,UAOK,EAtDA,aAuDLe,gBAAMpB,QAAN,EAvDK,YAwDLqB,kBAAQrB,QAAR,GAAmBK,OAAnB,CAA2B,YAA3B,EAAyC,QAAzC,CAxDK,YAyDLiB,gBAAQtB,QAAR,EAzDK,YA0DLuB,kBAAQvB,QAAR,EA1DK,YA2DLwB,eAAKxB,QAAL,EA3DD;AA4DA,aAAO,IAAIyB,QAAJ,CAAa,UAAb,EAAyBV,GAAzB,CAAP;AACD;;;;EAzTsCW,a;;kBAApB9F,W;;;AA4TrBA,YAAY+F,QAAZ,GAAuB;AACrB3F,aAAW,CADU;AAErBG,gBAAc,CAAC,EAAD,CAFO;AAGrBF,cAAY,CAHS;AAIrB2F,gBAAc,IAJO;AAKrBC,aAAW,KALU;AAMrBC,aAAW,IANU;AAOrBC,QAAM,QAPe;AAQrBC,WAAS,CARY;AASrBhB,iBAAe;AATM,CAAvB;;AAYApF,YAAYqG,aAAZ,GAA4BP,cAAIO,aAAhC","file":"rnn-time-step.js","sourcesContent":["import Matrix from './matrix';\r\nimport RandomMatrix from './matrix/random-matrix';\r\nimport Equation from './matrix/equation';\r\nimport RNN from './rnn';\r\nimport zeros from '../utilities/zeros';\r\nimport softmax from './matrix/softmax';\r\nimport {randomF} from '../utilities/random';\r\nimport sampleI from './matrix/sample-i';\r\nimport maxI from './matrix/max-i';\r\n\r\nexport default class RNNTimeStep extends RNN {\r\n  createInputMatrix() {\r\n    this.model.input = new RandomMatrix(this.inputSize, 1, 0.08);\r\n  }\r\n\r\n  createOutputMatrix() {\r\n    let model = this.model;\r\n    let outputSize = this.outputSize;\r\n    let lastHiddenSize = this.hiddenLayers[this.hiddenLayers.length - 1];\r\n\r\n    //whd\r\n    model.outputConnector = new RandomMatrix(outputSize, lastHiddenSize, 0.08);\r\n    //bd\r\n    model.output = new Matrix(outputSize, 1);\r\n  }\r\n\r\n  bindEquation() {\r\n    let model = this.model;\r\n    let hiddenLayers = this.hiddenLayers;\r\n    let layers = model.hiddenLayers;\r\n    let equation = new Equation();\r\n    let outputs = [];\r\n    let equationConnection = model.equationConnections.length > 0\r\n      ? model.equationConnections[model.equationConnections.length - 1]\r\n      : this.initialLayerInputs\r\n      ;\r\n\r\n      // 0 index\r\n    let output = this.getEquation(equation, equation.input(model.input), equationConnection[0], layers[0]);\r\n    outputs.push(output);\r\n    // 1+ indices\r\n    for (let i = 1, max = hiddenLayers.length; i < max; i++) {\r\n      output = this.getEquation(equation, output, equationConnection[i], layers[i]);\r\n      outputs.push(output);\r\n    }\r\n\r\n    model.equationConnections.push(outputs);\r\n    equation.add(equation.multiply(model.outputConnector, output), model.output);\r\n    model.equations.push(equation);\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {Number[]} input\r\n   * @returns {number}\r\n   */\r\n  runInput(input) {\r\n    this.runs++;\r\n    let model = this.model;\r\n    let errorSum = 0;\r\n    let equation;\r\n    while (model.equations.length < input.length - 1) {\r\n      this.bindEquation();\r\n    }\r\n    const outputs = [];\r\n\r\n    if (this.inputSize === 1) {\r\n      for (let inputIndex = 0, max = input.length - 1; inputIndex < max; inputIndex++) {\r\n        // start and end tokens are zeros\r\n        equation = model.equations[inputIndex];\r\n\r\n        const current = input[inputIndex];\r\n        const next = input[inputIndex + 1];\r\n        const output = equation.runInput([current]);\r\n        for (let i = 0; i < output.weights.length; i++) {\r\n          const error = output.weights[i] - next;\r\n          // set gradients into log probabilities\r\n          errorSum += Math.abs(error);\r\n\r\n          // write gradients into log probabilities\r\n          output.deltas[i] = error;\r\n          outputs.push(output.weights);\r\n        }\r\n      }\r\n    } else {\r\n      for (let inputIndex = 0, max = input.length - 1; inputIndex < max; inputIndex++) {\r\n        // start and end tokens are zeros\r\n        equation = model.equations[inputIndex];\r\n\r\n        const current = input[inputIndex];\r\n        const next = input[inputIndex + 1];\r\n        const output = equation.runInput(current);\r\n        for (let i = 0; i < output.weights.length; i++) {\r\n          const error = output.weights[i] - next[i];\r\n          // set gradients into log probabilities\r\n          errorSum += Math.abs(error);\r\n\r\n          // write gradients into log probabilities\r\n          output.deltas[i] = error;\r\n          outputs.push(output.weights);\r\n        }\r\n      }\r\n    }\r\n    //this.model.equations.length - 1;\r\n    this.totalCost = errorSum;\r\n    return errorSum;\r\n  }\r\n\r\n  runBackpropagate() {\r\n    for (let i = this.model.equations.length - 1; i > -1; i--) {\r\n      this.model.equations[i].runBackpropagate();\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   *\r\n   * @param {Number[]|Number[][]} [input]\r\n   * @returns {Number[]|Number}\r\n   */\r\n  run(input = []) {\r\n    if (!this.isRunnable) return null;\r\n    const model = this.model;\r\n    while (model.equations.length < input.length) {\r\n      this.bindEquation();\r\n    }\r\n    let lastOutput;\r\n    if (this.inputSize === 1) {\r\n      for (let i = 0; i < input.length; i++) {\r\n        let outputMatrix = model.equations[i].runInput([input[i]]);\r\n        lastOutput = outputMatrix.weights;\r\n      }\r\n    } else {\r\n      for (let i = 0; i < input.length; i++) {\r\n        let outputMatrix = model.equations[i].runInput(input[i]);\r\n        lastOutput = outputMatrix.weights;\r\n      }\r\n    }\r\n    if (this.outputSize === 1) {\r\n      return lastOutput[0]\r\n    }\r\n    return lastOutput;\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @returns {Function}\r\n   */\r\n  toFunction() {\r\n    let model = this.model;\r\n    let equations = this.model.equations;\r\n    const inputSize = this.inputSize;\r\n    debugger;\r\n    let equation = equations[1];\r\n    let states = equation.states;\r\n    let jsonString = JSON.stringify(this.toJSON());\r\n\r\n    function matrixOrigin(m, stateIndex) {\r\n      for (let i = 0, max = states.length; i < max; i++) {\r\n        let state = states[i];\r\n\r\n        if (i === stateIndex) {\r\n          let j = previousConnectionIndex(m);\r\n          switch (m) {\r\n            case state.left:\r\n              if (j > -1) {\r\n                return `typeof prevStates[${ j }] === 'object' ? prevStates[${ j }].product : new Matrix(${ m.rows }, ${ m.columns })`;\r\n              }\r\n            case state.right:\r\n              if (j > -1) {\r\n                return `typeof prevStates[${ j }] === 'object' ? prevStates[${ j }].product : new Matrix(${ m.rows }, ${ m.columns })`;\r\n              }\r\n            case state.product:\r\n              return `new Matrix(${ m.rows }, ${ m.columns })`;\r\n            default:\r\n              throw Error('unknown state');\r\n          }\r\n        }\r\n\r\n        if (m === state.product) return `states[${ i }].product`;\r\n        if (m === state.right) return `states[${ i }].right`;\r\n        if (m === state.left) return `states[${ i }].left`;\r\n      }\r\n    }\r\n\r\n    function previousConnectionIndex(m) {\r\n      const connection = model.equationConnections[0];\r\n      const states = equations[0].states;\r\n      for (let i = 0, max = states.length; i < max; i++) {\r\n        if (states[i].product === m) {\r\n          return i;\r\n        }\r\n      }\r\n      return connection.indexOf(m);\r\n    }\r\n\r\n    function matrixToString(m, stateIndex) {\r\n      if (!m || !m.rows || !m.columns) return 'null';\r\n\r\n      if (m === model.input) return `json.input`;\r\n      if (m === model.outputConnector) return `json.outputConnector`;\r\n      if (m === model.output) return `json.output`;\r\n\r\n      for (let i = 0, max = model.hiddenLayers.length; i < max; i++) {\r\n        let hiddenLayer = model.hiddenLayers[i];\r\n        for (let p in hiddenLayer) {\r\n          if (!hiddenLayer.hasOwnProperty(p)) continue;\r\n          if (hiddenLayer[p] !== m) continue;\r\n          return `json.hiddenLayers[${ i }].${ p }`;\r\n        }\r\n      }\r\n\r\n      return matrixOrigin(m, stateIndex);\r\n    }\r\n\r\n    function toInner(fnString) {\r\n      // crude, but should be sufficient for now\r\n      // function() { body }\r\n      fnString = fnString.toString().split('{');\r\n      fnString.shift();\r\n      // body }\r\n      fnString = fnString.join('{');\r\n      fnString = fnString.split('}');\r\n      fnString.pop();\r\n      // body\r\n\r\n      return fnString.join('}').split('\\n').join('\\n        ')\r\n        .replace('product.weights = _this.inputValue;', inputSize === 1 ? 'product.weights = [input[_i]];' : 'product.weights = input[_i];')\r\n        .replace('product.deltas[i] = 0;', '')\r\n        .replace('product.deltas[column] = 0;', '')\r\n        .replace('left.deltas[leftIndex] = 0;', '')\r\n        .replace('right.deltas[rightIndex] = 0;', '')\r\n        .replace('product.deltas = left.deltas.slice(0);', '');\r\n    }\r\n\r\n    function fileName(fnName) {\r\n      return `src/recurrent/matrix/${ fnName.replace(/[A-Z]/g, function(value) { return '-' + value.toLowerCase(); }) }.js`;\r\n    }\r\n\r\n    let statesRaw = [];\r\n    let usedFunctionNames = {};\r\n    let innerFunctionsSwitch = [];\r\n    for (let i = 0, max = states.length; i < max; i++) {\r\n      let state = states[i];\r\n      statesRaw.push(`states[${ i }] = {\r\n      name: '${ state.forwardFn.name }',\r\n      left: ${ matrixToString(state.left, i) },\r\n      right: ${ matrixToString(state.right, i) },\r\n      product: ${ matrixToString(state.product, i) }\r\n    }`);\r\n\r\n      let fnName = state.forwardFn.name;\r\n      if (!usedFunctionNames[fnName]) {\r\n        usedFunctionNames[fnName] = true;\r\n        innerFunctionsSwitch.push(\r\n          `        case '${ fnName }':${ fnName !== 'forwardFn' ? ` //compiled from ${ fileName(fnName) }` : '' }\r\n          ${ toInner(state.forwardFn.toString()) }\r\n          break;`\r\n        );\r\n      }\r\n    }\r\n\r\n    const src = `\r\n  if (typeof rawInput === 'undefined') rawInput = [];\r\n  ${ (this.dataFormatter !== null) ? this.dataFormatter.toFunctionString() : '' }\r\n  \r\n  var input = ${\r\n      (this.dataFormatter !== null && typeof this.formatDataIn === 'function')\r\n        ? 'formatDataIn(rawInput)'\r\n        : 'rawInput'\r\n      };\r\n  var json = ${ jsonString };\r\n  var output = [];\r\n  var states = [];\r\n  var prevStates;\r\n  var state;\r\n  for (let _i = 0; _i < input.length; _i++) {\r\n    prevStates = states;\r\n    states = [];\r\n    ${ statesRaw.join(';\\n    ') };\r\n    for (var stateIndex = 0, stateMax = ${ statesRaw.length }; stateIndex < stateMax; stateIndex++) {\r\n      state = states[stateIndex];\r\n      var product = state.product;\r\n      var left = state.left;\r\n      var right = state.right;\r\n      \r\n      switch (state.name) {\r\n${ innerFunctionsSwitch.join('\\n') }\r\n      }\r\n    }\r\n  }\r\n  ${\r\n    (this.dataFormatter !== null && typeof this.formatDataOut === 'function')\r\n      ? `return formatDataOut(input, ${ this.outputSize === 1 ? 'state.product.weights[0]' : 'state.product.weights' })`\r\n      : `return ${ this.outputSize === 1 ? 'state.product.weights[0]' : 'state.product.weights' }`\r\n  };\r\n  function Matrix(rows, columns) {\r\n    this.rows = rows;\r\n    this.columns = columns;\r\n    this.weights = zeros(rows * columns);\r\n  }\r\n  ${ this.dataFormatter !== null && typeof this.formatDataIn === 'function'\r\n        ? `function formatDataIn(input, output) { ${\r\n          toInner(this.formatDataIn.toString())\r\n            .replace(/this[.]dataFormatter[\\n\\s]+[.]/g, '')\r\n            .replace(/this[.]dataFormatter[.]/g, '')\r\n            .replace(/this[.]dataFormatter/g, 'true')\r\n          } }`\r\n        : '' }\r\n  ${ this.dataFormatter !== null && typeof this.formatDataOut === 'function'\r\n        ? `function formatDataOut(input, output) { ${\r\n          toInner(this.formatDataOut.toString())\r\n            .replace(/this[.]dataFormatter[\\n\\s]+[.]/g, '')\r\n            .replace(/this[.]dataFormatter[.]/g, '')\r\n            .replace(/this[.]dataFormatter/g, 'true')\r\n          } }`\r\n        : '' }\r\n  ${ zeros.toString() }\r\n  ${ softmax.toString().replace('_2.default', 'Matrix') }\r\n  ${ randomF.toString() }\r\n  ${ sampleI.toString() }\r\n  ${ maxI.toString() }`\r\n    return new Function('rawInput', src);\r\n  }\r\n}\r\n\r\nRNNTimeStep.defaults = {\r\n  inputSize: 1,\r\n  hiddenLayers: [20],\r\n  outputSize: 1,\r\n  learningRate: 0.01,\r\n  decayRate: 0.999,\r\n  smoothEps: 1e-8,\r\n  regc: 0.000001,\r\n  clipval: 5,\r\n  dataFormatter: null\r\n};\r\n\r\nRNNTimeStep.trainDefaults = RNN.trainDefaults;"]}