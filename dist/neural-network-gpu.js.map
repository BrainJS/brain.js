{"version":3,"sources":["../src/neural-network-gpu.js"],"names":["NeuralNetworkGPU","options","Object","assign","defaults","hiddenSizes","hiddenLayers","layers","sizes","outputLayer","biases","weights","outputs","forwardPropagate","backwardPropagate","changesPropagate","weightsPropagate","biasesPropagate","weightsToFloat","megaKernel","deltas","changes","errors","count","error","logCount","gpu","mode","keepNetworkIntact","length","layer","size","Array","node","prevSize","buildRunInput","buildCalculateDeltas","buildGetChanges","buildChangeBiases","data","_options","trainDefaults","formatData","iterations","errorThresh","log","console","logPeriod","learningRate","callback","callbackPeriod","inputSize","input","outputSize","output","push","Math","max","floor","forEach","unshift","initialize","i","sum","j","err","trainPattern","target","runInput","calculateDeltas","getChanges","changeBiases","toArray","weightedSum","x","inputs","k","exp","kernel","createKernelMap","thread","constants","setDimensions","setOutputToTexture","result","calcError","calcDeltas","calcErrorOutput","nextWeights","nextDeltas","createKernelCallback","calcChanges","previousChange","previousOutputs","momentum","y","addWeights","change","delta","addBiases","inputLookup","outputLookup","toHash","constructor","tmp","datum","Float64Array","buildLookup","map","value","array","binaryThresh"],"mappings":"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","file":"neural-network-gpu.js","sourcesContent":["import lookup from './lookup';\r\nimport TrainStream from './train-stream';\r\nimport max from './utilities/max';\r\nimport mse from './utilities/mse';\r\nimport randos from './utilities/randos';\r\nimport range from './utilities/range';\r\nimport toArray from './utilities/to-array';\r\nimport zeros from './utilities/zeros';\r\nimport GPU from 'gpu.js';\r\n\r\n/**\r\n *\r\n * @param {object} options\r\n * @constructor\r\n */\r\nexport default class NeuralNetworkGPU {\r\n  constructor(options = {}) {\r\n    Object.assign(this, NeuralNetworkGPU.defaults, options);\r\n    this.hiddenSizes = options.hiddenLayers;\r\n    this.layers = null;\r\n    this.sizes = null;\r\n    this.outputLayer = null;\r\n    this.biases = null; // weights for bias nodes\r\n    this.weights = null;\r\n    this.outputs = null;\r\n\r\n    this.forwardPropagate = [];\r\n    this.backwardPropagate = [];\r\n    this.changesPropagate = [];\r\n    this.weightsPropagate = [];\r\n    this.biasesPropagate = [];\r\n    this.weightsToFloat = [];\r\n    this.megaKernel = [];\r\n    // state for training\r\n    this.deltas = null;\r\n    this.changes = null; // for momentum\r\n    this.errors = null;\r\n    this.count = 0;\r\n    this.error = 1;\r\n    this.logCount = 200\r\n    this.gpu = new GPU({mode: 'gpu'});\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {} sizes\r\n   * @param {Boolean} keepNetworkIntact\r\n   */\r\n  initialize(sizes, keepNetworkIntact) {\r\n    this.sizes = sizes;\r\n    this.outputLayer = this.sizes.length - 1;\r\n\r\n    if (!keepNetworkIntact) {\r\n      this.biases = []; // weights for bias nodes\r\n      this.weights = [];\r\n      this.outputs = [];\r\n    }\r\n\r\n    // state for training\r\n    this.changes = []; // for momentum\r\n    this.deltas = [];\r\n    this.errors = [];\r\n\r\n    for (let layer = 0; layer <= this.outputLayer; layer++) {\r\n      let size = this.sizes[layer];\r\n      this.deltas[layer] = zeros(size);\r\n      this.errors[layer] = zeros(size);\r\n      if (!keepNetworkIntact) {\r\n        this.outputs[layer] = zeros(size);\r\n      }\r\n\r\n      if (layer > 0) {\r\n        this.biases[layer] = randos(size);\r\n\r\n        if (!keepNetworkIntact) {\r\n          this.weights[layer] = new Array(size);\r\n        }\r\n        this.changes[layer] = new Array(size);\r\n\r\n        for (let node = 0; node < size; node++) {\r\n          let prevSize = this.sizes[layer - 1];\r\n          if (!keepNetworkIntact) {\r\n            this.weights[layer][node] = randos(prevSize);\r\n          }\r\n          this.changes[layer][node] = zeros(prevSize);\r\n        }\r\n      }\r\n    }\r\n    this.buildRunInput();\r\n    this.buildCalculateDeltas();\r\n    this.buildGetChanges();\r\n    this.buildChangeBiases();\r\n  }\r\n\r\n\r\n  /**\r\n   *\r\n   * @param data\r\n   * @param options\r\n   * @returns {{error: number, iterations: number}}\r\n   */\r\n  train(data, _options = {}) {\r\n    const options = Object.assign({}, NeuralNetworkGPU.trainDefaults, _options);\r\n    data = this.formatData(data);\r\n    let iterations = options.iterations;\r\n    let errorThresh = options.errorThresh;\r\n    let log = options.log === true ? console.log : options.log;\r\n    let logPeriod = options.logPeriod;\r\n    let learningRate = _options.learningRate || this.learningRate || options.learningRate;\r\n    let callback = options.callback;\r\n    let callbackPeriod = options.callbackPeriod;\r\n    let sizes = [];\r\n    let inputSize = data[0].input.length;\r\n    let outputSize = data[0].output.length;\r\n    let hiddenSizes = this.hiddenSizes;\r\n    if (!hiddenSizes) {\r\n      sizes.push(Math.max(3, Math.floor(inputSize / 2)));\r\n    } else {\r\n      hiddenSizes.forEach(size => {\r\n        sizes.push(size);\r\n      });\r\n    }\r\n\r\n    sizes.unshift(inputSize);\r\n\r\n    sizes.push(outputSize);\r\n\r\n    this.initialize(sizes, options.keepNetworkIntact);\r\n\r\n    let error = 1;\r\n    let i;\r\n    for (i = 1; i < iterations && error > errorThresh; i++) {\r\n      this.count++;\r\n      let sum = 0;\r\n      for (let j = 0; j < data.length; j++) {\r\n        let err = this.trainPattern(data[j].input, data[j].output, learningRate);\r\n        sum += err;\r\n      }\r\n      \r\n      error = sum / data.length;\r\n\r\n      if (log && (i % this.logCount == 0) || log && i == 1) {\r\n        log('iterations:', i, 'training error:', error);\r\n      }\r\n      if (callback && (i % callbackPeriod == 0)) {\r\n        callback({ error: error, iterations: i });\r\n      }\r\n    \r\n    this.error = error;\r\n    }\r\n    return {\r\n      error: error,\r\n      iterations: i\r\n    };\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param input\r\n   * @param target\r\n   * @param learningRate\r\n   */\r\n  trainPattern(input, target, learningRate) {\r\n    learningRate = learningRate || this.learningRate;\r\n    // forward propagate\r\n    this.runInput(input);\r\n\r\n    // backward propagate\r\n    this.calculateDeltas(target);\r\n    this.getChanges(learningRate);\r\n    this.changeBiases(learningRate);\r\n    \r\n    if (this.count % this.logCount == 0 || this.count == 1 || this.iterations == this.count) {\r\n      for (let i = 0; i < this.errors.length; i++) {\r\n        this.errors[i] = this.errors[i].toArray\r\n          ? this.errors[i].toArray(this.gpu)\r\n          : this.errors[i];\r\n      }\r\n      let error = this.error = mse(this.errors[this.outputLayer]);\r\n      return error;\r\n    } else {\r\n      return this.error;\r\n    }\r\n  }\r\n\r\n  buildRunInput() {\r\n    function weightedSum(weights, biases, x, inputs) {\r\n      var sum = biases[x];\r\n      for (var k = 0; k < size; k++) {\r\n        sum += weights[x][k] * inputs[k];\r\n      }\r\n      return 1 / (1 + Math.exp(-sum));\r\n    }\r\n\r\n    for(var layer = 1; layer <= this.outputLayer; layer++){\r\n      const kernel = this.gpu.createKernelMap({weightedSum}, \r\n        function(weights, biases, inputs){\r\n          return weightedSum(weights, biases, this.thread.x, inputs);\r\n        }, {\r\n        constants:{\r\n          size: this.sizes[layer - 1]\r\n        }\r\n      })\r\n      .setDimensions([this.sizes[layer]])\r\n      .setOutputToTexture(true);\r\n      this.forwardPropagate[layer] = kernel;\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param input\r\n   * @returns {*}\r\n   */\r\n  runInput(input){\r\n    let output;\r\n    this.outputs[0] = input;\r\n    for (var layer = 1; layer <= this.outputLayer; layer++) {\r\n      this.outputs[layer] = this.forwardPropagate[layer](\r\n        this.weights[layer], \r\n        this.biases[layer], \r\n        input\r\n      ).result;\r\n\r\n      output = input = this.outputs[layer];\r\n    }\r\n      // console.log(this.outputs[2], 'Outputs')\r\n    return output;\r\n  }\r\n\r\n  buildCalculateDeltas(target){\r\n\r\n    function calcError(outputs, target) {\r\n      return target[this.thread.x] - outputs;\r\n    }\r\n\r\n    function calcDeltas(error, output) {\r\n      return error * output * (1 - output);\r\n    }\r\n\r\n    function calcErrorOutput(nextWeights, nextDeltas){\r\n      var error = 0;\r\n      for(var k = 0; k < size; k++){\r\n        error += nextDeltas[k] * nextWeights[k][this.thread.x];\r\n      }\r\n      return error;\r\n    }\r\n\r\n    function createKernelCallback(outputs, target){\r\n          var output = outputs[this.thread.x];\r\n          return calcDeltas(calcError(output, target), output);\r\n    }\r\n\r\n    for(var layer = this.outputLayer; layer > 0; layer--){\r\n      if(layer == this.outputLayer){\r\n        const kernel = this.gpu.createKernelMap({\r\n          error: calcError,\r\n          deltas: calcDeltas\r\n        }, createKernelCallback)\r\n       .setDimensions([this.sizes[layer]]) \r\n       .setOutputToTexture(true);\r\n        \r\n        this.backwardPropagate[layer] = kernel;\r\n\r\n      }else{\r\n        const kernel = this.gpu.createKernelMap({\r\n          error: calcErrorOutput,\r\n          deltas: calcDeltas,\r\n        }, function(nextWeights, outputs, nextDeltas){\r\n          var output = outputs[this.thread.x];\r\n          return calcDeltas(calcErrorOutput(nextWeights, nextDeltas), output);\r\n        }, {\r\n          constants: {\r\n            size: this.deltas[layer + 1].length\r\n          }\r\n        })\r\n        .setDimensions([this.sizes[layer]])\r\n        .setOutputToTexture(true);\r\n        \r\n        this.backwardPropagate[layer] = kernel;\r\n      }\r\n    }\r\n  }\r\n\r\n  calculateDeltas(target,learningRate){\r\n    for (var layer = this.outputLayer; layer > 0; layer--) {\r\n      let output;\r\n      if(layer == this.outputLayer){\r\n        output = this.backwardPropagate[layer](\r\n          this.outputs[layer],\r\n          target);\r\n      } else {\r\n        output = this.backwardPropagate[layer](\r\n          this.weights[layer + 1],\r\n          this.outputs[layer],\r\n          this.deltas[layer + 1],\r\n        )}\r\n\r\n      this.deltas[layer] = output.result; \r\n      this.errors[layer] = output.error;\r\n    }\r\n      // console.log(this.errors[2], 'errors');\r\n      // console.log(this.deltas[2], 'deltas');\r\n  }\r\n\r\n  buildGetChanges(){\r\n    function calcChanges(previousChange, deltas, previousOutputs, learningRate, momentum, x, y) {\r\n      var sum = 0;\r\n      for (var i = 0; i < size; i++) {\r\n        sum += (learningRate * deltas * previousOutputs[x])\r\n                + (momentum * previousChange[y][i]);\r\n      }\r\n      return sum;\r\n    }\r\n\r\n    function addWeights(change, weights, x, y){\r\n      return change + weights[y][x];\r\n    }\r\n\r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n     const kernel = this.gpu.createKernelMap({addWeights, calcChanges},\r\n        function(previousOutputs, deltas, weights, changes, learningRate, momentum){\r\n          var delta = deltas[this.thread.y];\r\n          var change = calcChanges(\r\n            changes, \r\n            delta, \r\n            previousOutputs, \r\n            learningRate, \r\n            momentum, \r\n            this.thread.x, \r\n            this.thread.y);\r\n\r\n          return addWeights(change, weights, this.thread.x, this.thread.y);\r\n        },{\r\n          constants:{\r\n            size: this.outputs[layer - 1].length\r\n          }\r\n        })\r\n          .setDimensions([this.sizes[layer -1], this.sizes[layer]])\r\n          .setOutputToTexture(true)\r\n        \r\n      this.changesPropagate[layer] = kernel;\r\n    }    \r\n  }\r\n  \r\n  getChanges(learningRate){\r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n      let output = this.changesPropagate[layer](\r\n        this.outputs[layer - 1],\r\n        this.deltas[layer],\r\n        this.weights[layer],\r\n        this.changes[layer],\r\n        learningRate,\r\n        this.momentum\r\n      );\r\n      \r\n      this.changes[layer] = output.calcChanges;\r\n      this.weights[layer] = output.result;\r\n    }\r\n      // console.log(this.weights[1][0], 'weights');\r\n      // console.log(this.changes[1][0], 'changes');\r\n    \r\n  }\r\n\r\n  buildChangeBiases() {\r\n    function addBiases(biases, deltas, learningRate, x){\r\n      return biases[x] + (deltas[x] * learningRate);\r\n    }\r\n    \r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n      const kernel = this.gpu.createKernelMap({\r\n        addBiases\r\n      }, function (biases, deltas, learningRate) {\r\n        return addBiases(biases, deltas, learningRate, this.thread.x);\r\n      })\r\n        .setDimensions([this.sizes[layer]])\r\n        .setOutputToTexture(true);\r\n\r\n      this.biasesPropagate[layer] = kernel;\r\n    }\r\n  }\r\n\r\n  changeBiases(learningRate) {\r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n      let output = this.biasesPropagate[layer](\r\n        this.biases[layer],\r\n        this.deltas[layer],\r\n        learningRate\r\n      );\r\n      this.biases[layer] = output.result;\r\n    }\r\n    // console.log(this.biases[2], 'biases')\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param input\r\n   * @returns {*}\r\n   */\r\n  run(input) {\r\n    if (this.inputLookup) {\r\n      input = lookup.toArray(this.inputLookup, input);\r\n    }\r\n    let output = this.runInput(input);\r\n\r\n    if (this.outputLookup) {\r\n      output = lookup.toHash(this.outputLookup, output);\r\n    }\r\n    return output;\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param data\r\n   * @returns {*}\r\n   */\r\n  formatData(data) {\r\n    if (data.constructor !== Array) { // turn stream datum into array\r\n      let tmp = [];\r\n      tmp.push(data);\r\n      data = tmp;\r\n    }\r\n    // turn sparse hash input into arrays with 0s as filler\r\n    let datum = data[0].input;\r\n    if (datum.constructor !== Array && !(datum instanceof Float64Array)) {\r\n      if (!this.inputLookup) {\r\n        this.inputLookup = lookup.buildLookup(data.map(value => value['input']));\r\n      }\r\n      data = data.map(datum => {\r\n        let array = lookup.toArray(this.inputLookup, datum.input);\r\n        return Object.assign({}, datum, { input: array });\r\n      }, this);\r\n    }\r\n\r\n    if (data[0].output.constructor !== Array) {\r\n      if (!this.outputLookup) {\r\n        this.outputLookup = lookup.buildLookup(data.map(value => value['output']));\r\n      }\r\n      data = data.map(datum => {\r\n        let array = lookup.toArray(this.outputLookup, datum.output);\r\n        return Object.assign({}, datum, { output: array });\r\n      }, this);\r\n    }\r\n    return data;\r\n  }\r\n\r\n}\r\n\r\nNeuralNetworkGPU.trainDefaults = {\r\n  iterations: 20000,\r\n  errorThresh: 0.005,\r\n  log: false,\r\n  logPeriod: 10,\r\n  learningRate: 0.3,\r\n  callback: null,\r\n  callbackPeriod: 10,\r\n  keepNetworkIntact: false\r\n};\r\n\r\nNeuralNetworkGPU.defaults = {\r\n  learningRate: 0.3,\r\n  momentum: 0.1,\r\n  binaryThresh: 0.5,\r\n  hiddenLayers: null\r\n};"]}