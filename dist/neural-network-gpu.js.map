{"version":3,"sources":["../src/neural-network-gpu.js"],"names":["NeuralNetworkGPU","options","forwardPropagate","backwardPropagate","changesPropagate","biasesPropagate","biasCopies","copyBias","changesCopies","copyChanges","weightsCopies","copyWeights","errorCheckInterval","gpu","GPU","mode","buildRunInput","buildCalculateDeltas","buildGetChanges","buildChangeBiases","buildGetMSE","input","target","logErrorRate","runInput","calculateDeltas","getChanges","changeBiases","getMSE","errors","outputLayer","weightedSum","activation","weightedSumSigmoid","weightedSumRelu","weightedSumLeakyRelu","weightedSumTanh","Error","layer","createKernel","output","sizes","outputToTexture","hardcodeConstants","constants","size","_texturizeInputData","value","thread","x","outputImmutable","outputs","weights","biases","calcDeltas","calcDeltasSigmoid","calcDeltasRelu","calcDeltasLeakyRelu","calcDeltasTanh","createKernelMap","error","alias","calcErrorOutput","deltas","targets","calcError","nextWeights","nextDeltas","length","addWeights","changes","calcChanges","previousOutputs","change","learningRate","trainOpts","momentum","y","hardCodeConstants","addBiases","mse","isRunnable","inputLookup","lookup","toArray","inputTexture","outputTextures","outputLookup","toHash","data","push","hiddenLayers","Math","max","floor","forEach","_initialize","_updateTrainingOptions","_formatData","endTime","Date","now","timeout","status","iterations","_verifyIsInitialized","texturizeOutputData","map","set","NeuralNetwork","inputs","sum","k","exp","tanh","previousChanges","i","pow"],"mappings":"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","file":"neural-network-gpu.js","sourcesContent":["import NeuralNetwork from './neural-network';\r\nimport lookup from './lookup';\r\nimport GPU from 'gpu.js';\r\n\r\n/**\r\n *\r\n * @param {object} options\r\n * @constructor\r\n */\r\nexport default class NeuralNetworkGPU extends NeuralNetwork {\r\n  constructor(options = {}) {\r\n    super(options);\r\n    this.forwardPropagate = [];\r\n    this.backwardPropagate = [];\r\n    this.changesPropagate = [];\r\n    this.biasesPropagate = [];\r\n    this.biasCopies = [];\r\n    this.copyBias = [];\r\n    this.changesCopies = [];\r\n    this.copyChanges = [];\r\n    this.weightsCopies = [];\r\n    this.copyWeights = [];\r\n    this.errorCheckInterval = 100;\r\n    this.gpu = new GPU({mode: options.mode});\r\n  }\r\n\r\n  /**\r\n   *\r\n   */\r\n  _initialize() {\r\n    super._initialize();\r\n    this.buildRunInput();\r\n    this.buildCalculateDeltas();\r\n    this.buildGetChanges();\r\n    this.buildChangeBiases();\r\n    this.buildGetMSE();\r\n  }\r\n\r\n  setActivation() {}\r\n\r\n  /**\r\n   *\r\n   * @param input\r\n   * @param target\r\n   * @param logErrorRate\r\n   */\r\n  _trainPattern(input, target, logErrorRate) {\r\n    // forward propagate\r\n    this.runInput(input);\r\n\r\n    // backward propagate\r\n    this.calculateDeltas(target);\r\n    this.getChanges();\r\n    this.changeBiases();\r\n\r\n    if (logErrorRate) {\r\n      return this.getMSE(this.errors[this.outputLayer])[0];\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  buildRunInput() {\r\n    let weightedSum = null;\r\n\r\n    switch (this.activation) {\r\n      case 'sigmoid':\r\n        weightedSum = weightedSumSigmoid;\r\n        break;\r\n      case 'relu':\r\n        weightedSum = weightedSumRelu;\r\n        break;\r\n      case 'leaky-relu':\r\n        weightedSum = weightedSumLeakyRelu;\r\n        break;\r\n      case 'tanh':\r\n        weightedSum = weightedSumTanh;\r\n        break;\r\n      default:\r\n        throw new Error('unknown activation ' + this.activation);\r\n    }\r\n\r\n    for(let layer = 1; layer <= this.outputLayer; layer++){\r\n      this.forwardPropagate[layer] = this.gpu.createKernel(weightedSum, {\r\n        output: [this.sizes[layer]],\r\n        outputToTexture: true,\r\n        hardcodeConstants: true,\r\n        constants: {\r\n          size: this.sizes[layer - 1]\r\n        }\r\n      });\r\n    }\r\n\r\n    this._texturizeInputData = this.gpu.createKernel(function(value) {\r\n      return value[this.thread.x];\r\n    }, {\r\n      output: [this.sizes[1]],\r\n      outputToTexture: true,\r\n      hardcodeConstants: true,\r\n      outputImmutable: true\r\n    });\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param input\r\n   * @returns {*}\r\n   */\r\n  runInput(input) {\r\n    let output;\r\n    this.outputs[0] = input;\r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n      this.outputs[layer] = this.forwardPropagate[layer](\r\n        this.weights[layer], \r\n        this.biases[layer], \r\n        input\r\n      );\r\n      output = input = this.outputs[layer];\r\n    }\r\n    return output;\r\n  }\r\n\r\n  buildCalculateDeltas() {\r\n    let calcDeltas = null;\r\n\r\n    switch (this.activation) {\r\n      case 'sigmoid':\r\n        calcDeltas = calcDeltasSigmoid;\r\n        break;\r\n      case 'relu':\r\n        calcDeltas = calcDeltasRelu;\r\n        break;\r\n      case 'leaky-relu':\r\n        calcDeltas = calcDeltasLeakyRelu;\r\n        break;\r\n      case 'tanh':\r\n        calcDeltas = calcDeltasTanh;\r\n        break;\r\n      default:\r\n        throw new Error('unknown activation ' + this.activation);\r\n    }\r\n\r\n    for (let layer = this.outputLayer; layer > 0; layer--) {\r\n      if (layer === this.outputLayer) {\r\n        this.backwardPropagate[layer] = this.gpu.createKernelMap({\r\n            error: GPU.alias('calcErrorOutput', calcErrorOutput),\r\n            deltas: GPU.alias('calcDeltas', calcDeltas)\r\n          }, function(outputs, targets) {\r\n            const output = outputs[this.thread.x];\r\n            return calcDeltas(calcErrorOutput(output, targets), output);\r\n          }, {\r\n            output: [this.sizes[layer]],\r\n            outputToTexture: true,\r\n            hardcodeConstants: true\r\n          });\r\n      } else {\r\n        this.backwardPropagate[layer] = this.gpu.createKernelMap({\r\n            error: GPU.alias('calcError', calcError),\r\n            deltas: GPU.alias('calcDeltas', calcDeltas),\r\n          }, function(nextWeights, outputs, nextDeltas){\r\n            let output = outputs[this.thread.x];\r\n            return calcDeltas(calcError(nextWeights, nextDeltas), output);\r\n          }, {\r\n            output: [this.sizes[layer]],\r\n            outputToTexture: true,\r\n            hardcodeConstants: true,\r\n            constants: {\r\n              size: this.deltas[layer + 1].length\r\n            }\r\n          });\r\n      }\r\n    }\r\n  }\r\n\r\n  calculateDeltas(target) {\r\n    for (let layer = this.outputLayer; layer > 0; layer--) {\r\n      let output;\r\n\r\n      if (layer === this.outputLayer) {\r\n        output = this.backwardPropagate[layer](\r\n          this.outputs[layer],\r\n          target);\r\n      } else {\r\n        output = this.backwardPropagate[layer](\r\n          this.weights[layer + 1],\r\n          this.outputs[layer],\r\n          this.deltas[layer + 1],\r\n        );\r\n      }\r\n\r\n      this.deltas[layer] = output.deltas;\r\n      this.errors[layer] = output.error;\r\n    }\r\n  }\r\n\r\n  buildGetChanges() {\r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n      this.changesPropagate[layer] = this.gpu.createKernelMap({\r\n          weights: GPU.alias('addWeights', addWeights),\r\n          changes: GPU.alias('calcChanges', calcChanges)\r\n        },\r\n        function(previousOutputs, deltas, weights, changes) {\r\n          let change = calcChanges(\r\n            changes,\r\n            deltas,\r\n            previousOutputs);\r\n\r\n            return addWeights(change, weights);\r\n        }, {\r\n          output: [this.sizes[layer - 1], this.sizes[layer]],\r\n          outputToTexture: true,\r\n          hardcodeConstants: true,\r\n          constants:{\r\n            size: this.outputs[layer - 1].length,\r\n            learningRate: this.trainOpts.learningRate,\r\n            momentum: this.trainOpts.momentum\r\n          }\r\n        });\r\n\r\n      this.copyChanges[layer] = this.gpu.createKernel(function(value) {\r\n        return value[this.thread.y][this.thread.x];\r\n      }, {\r\n        output: this.changesPropagate[layer].output,\r\n        outputToTexture: true,\r\n        hardCodeConstants: true\r\n      });\r\n\r\n      this.copyWeights[layer] = this.gpu.createKernel(function(value) {\r\n        return value[this.thread.y][this.thread.x];\r\n      }, {\r\n        output: this.changesPropagate[layer].output,\r\n        outputToTexture: true,\r\n        hardCodeConstants: true\r\n      });\r\n    }    \r\n  }\r\n  \r\n  getChanges() {\r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n      let output = this.changesPropagate[layer](\r\n        this.outputs[layer - 1],\r\n        this.deltas[layer],\r\n        this.weightsCopies[layer] || this.weights[layer],\r\n        this.changesCopies[layer] || this.changes[layer]\r\n      );\r\n      this.changes[layer] = output.changes;\r\n      this.weights[layer] = output.weights;\r\n\r\n      this.changesCopies[layer] = this.copyChanges[layer](output.changes);\r\n      this.weightsCopies[layer] = this.copyWeights[layer](output.weights);\r\n    }\r\n  }\r\n\r\n  buildChangeBiases() {\r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n      this.biasesPropagate[layer] = this.gpu.createKernel(addBiases, {\r\n        output: [this.sizes[layer]],\r\n        outputToTexture: true,\r\n        hardcodeConstants: true,\r\n        constants: {\r\n          learningRate: this.trainOpts.learningRate\r\n        }\r\n      });\r\n      this.copyBias[layer] = this.gpu.createKernel(function(value) {\r\n        return value[this.thread.x];\r\n      }, {\r\n        output: this.biasesPropagate[layer].output,\r\n        outputToTexture: true,\r\n        hardCodeConstants: true\r\n      });\r\n    }\r\n  }\r\n\r\n  changeBiases() {\r\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\r\n      this.biases[layer] = this.biasesPropagate[layer](\r\n        this.biasCopies[layer] || this.biases[layer],\r\n        this.deltas[layer]\r\n      );\r\n      this.biasCopies[layer] = this.copyBias[layer](this.biases[layer]);\r\n    }\r\n  }\r\n\r\n  buildGetMSE() {\r\n    this.getMSE = this.gpu.createKernel(mse, {\r\n      output: [1],\r\n      hardcodeConstants: true,\r\n      constants: {\r\n        size: this.sizes[this.outputLayer]\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param input\r\n   * @returns {*}\r\n   */\r\n  run(input) {\r\n    if (!this.isRunnable) return null;\r\n    if (this.inputLookup) {\r\n      input = lookup.toArray(this.inputLookup, input);\r\n    }\r\n    const inputTexture = this._texturizeInputData(input);\r\n    const outputTextures = this.runInput(inputTexture);\r\n    let output = outputTextures.toArray(this.gpu);\r\n\r\n    if (this.outputLookup) {\r\n      output = lookup.toHash(this.outputLookup, output);\r\n    }\r\n    return output;\r\n  }\r\n\r\n\r\n  /**\r\n   *\r\n   * @param data\r\n   * Verifies network sizes are initilaized\r\n   * If they are not it will initialize them based off the data set.\r\n   */\r\n  _verifyIsInitialized(data) {\r\n    if (this.sizes) return;\r\n\r\n    this.sizes = [];\r\n    if (!data[0].size) {\r\n      data[0].size = { input: data[0].input.length, output: data[0].output.length };\r\n    }\r\n\r\n    this.sizes.push(data[0].size.input);\r\n    if (!this.hiddenLayers) {\r\n      this.sizes.push(Math.max(3, Math.floor(data[0].size.input / 2)));\r\n    } else {\r\n      this.hiddenLayers.forEach(size => {\r\n        this.sizes.push(size);\r\n      });\r\n    }\r\n    this.sizes.push(data[0].size.output);\r\n\r\n    this._initialize();\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param data\r\n   * @param options\r\n   * @protected\r\n   * @return { data, status, endTime }\r\n   */\r\n  _prepTraining(data, options) {\r\n    this._updateTrainingOptions(options);\r\n    data = this._formatData(data);\r\n    const endTime = Date.now() + this.trainOpts.timeout;\r\n\r\n    const status = {\r\n      error: 1,\r\n      iterations: 0\r\n    };\r\n\r\n    this._verifyIsInitialized(data);\r\n\r\n    const texturizeOutputData = this.gpu.createKernel(function(value) {\r\n      return value[this.thread.x];\r\n    }, {\r\n      output: [data[0].output.length],\r\n      outputToTexture: true,\r\n      hardcodeConstants: true,\r\n      outputImmutable: true\r\n    });\r\n\r\n    return {\r\n      data: data.map((set) => {\r\n        return {\r\n          size: set.size,\r\n          input: this._texturizeInputData(set.input),\r\n          output: texturizeOutputData(set.output)\r\n        }\r\n      }),\r\n      status,\r\n      endTime\r\n    };\r\n  }\r\n\r\n  toFunction() {\r\n    throw new Error('not implemented on NeuralNetworkGPU');\r\n  }\r\n\r\n}\r\n\r\nfunction weightedSumSigmoid(weights, biases, inputs) {\r\n  let sum = biases[this.thread.x];\r\n  for (let k = 0; k < this.constants.size; k++) {\r\n    sum += weights[this.thread.x][k] * inputs[k];\r\n  }\r\n  //sigmoid\r\n  return 1 / (1 + Math.exp(-sum));\r\n}\r\n\r\nfunction weightedSumRelu(weights, biases, inputs) {\r\n  let sum = biases[this.thread.x];\r\n  for (let k = 0; k < this.constants.size; k++) {\r\n    sum += weights[this.thread.x][k] * inputs[k];\r\n  }\r\n  //relu\r\n  return (sum < 0 ? 0 : sum);\r\n}\r\n\r\nfunction weightedSumLeakyRelu(weights, biases, inputs) {\r\n  let sum = biases[this.thread.x];\r\n  for (let k = 0; k < this.constants.size; k++) {\r\n    sum += weights[this.thread.x][k] * inputs[k];\r\n  }\r\n  //leaky relu\r\n  return (sum < 0 ? 0 : 0.01 * sum);\r\n}\r\n\r\nfunction weightedSumTanh(weights, biases, inputs) {\r\n  let sum = biases[this.thread.x];\r\n  for (let k = 0; k < this.constants.size; k++) {\r\n    sum += weights[this.thread.x][k] * inputs[k];\r\n  }\r\n  //tanh\r\n  return Math.tanh(sum);\r\n}\r\n\r\nfunction calcErrorOutput(output, targets) {\r\n  return targets[this.thread.x] - output;\r\n}\r\n\r\nfunction calcDeltasSigmoid(error, output) {\r\n  //sigmoid derivative\r\n  return error * output * (1 - output);\r\n}\r\n\r\nfunction calcDeltasRelu(error, output) {\r\n  //relu derivative\r\n  return output > 0 ? error : 0;\r\n}\r\n\r\nfunction calcDeltasLeakyRelu(error, output) {\r\n  //leaky relu derivative\r\n  return output > 0 ? error : 0.01 * error;\r\n}\r\n\r\nfunction calcDeltasTanh(error, output) {\r\n  //tanh derivative\r\n  return (1 - output * output) * error;\r\n}\r\n\r\nfunction calcError(nextWeights, nextDeltas){\r\n  let error = 0;\r\n  for(let k = 0; k < this.constants.size; k++){\r\n    error += nextDeltas[k] * nextWeights[k][this.thread.x];\r\n  }\r\n  return error;\r\n}\r\n\r\nfunction calcChanges(\r\n  previousChanges,\r\n  deltas,\r\n  previousOutputs\r\n) {\r\n  return (this.constants.learningRate * deltas[this.thread.y] * previousOutputs[this.thread.x])\r\n      + (this.constants.momentum * previousChanges[this.thread.y][this.thread.x]);\r\n}\r\n\r\nfunction addWeights(change, weights){\r\n  return change + weights[this.thread.y][this.thread.x];\r\n}\r\n\r\nfunction addBiases(biases, deltas){\r\n  return biases[this.thread.x] + (deltas[this.thread.x] * this.constants.learningRate);\r\n}\r\n\r\n// mean squared error, reimplemented for GPU\r\nfunction mse(errors) {\r\n  let sum = 0;\r\n  for (let i = 0; i < this.constants.size; i++) {\r\n    sum += Math.pow(errors[i], 2);\r\n  }\r\n  return sum / this.constants.size;\r\n}"]}